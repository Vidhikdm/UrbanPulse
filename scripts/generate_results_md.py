#!/usr/bin/env python3
"""
Generate README-friendly markdown from outputs/results/*.csv

Writes: outputs/results/RESULTS.md
"""
from __future__ import annotations
from pathlib import Path
import pandas as pd

ROOT = Path(__file__).resolve().parents[1]
OUT_DIR = ROOT / "outputs" / "results"
OUT_DIR.mkdir(parents=True, exist_ok=True)

def fmt_money(x: float) -> str:
    try:
        return f"${x:,.0f}"
    except Exception:
        return str(x)

def md_table(df: pd.DataFrame, cols: list[str], headers: list[str]) -> str:
    lines = []
    lines.append("| " + " | ".join(headers) + " |")
    lines.append("| " + " | ".join(["---"] * len(headers)) + " |")
    for _, r in df.iterrows():
        row = []
        for c in cols:
            v = r[c]
            if c.lower() in ["mae", "rmse"]:
                row.append(fmt_money(float(v)))
            elif c.lower() in ["r2", "spearman"]:
                row.append(f"{float(v):.3f}")
            elif c.lower() in ["log_target"]:
                row.append(str(bool(v)))
            else:
                row.append(str(v))
        lines.append("| " + " | ".join(row) + " |")
    return "\n".join(lines)

def main() -> int:
    # Cross-city
    cross_path = OUT_DIR / "cross_city_summary.csv"
    abl_path = OUT_DIR / "ablation_nyc.csv"

    parts = []
    parts.append("# Results (auto-generated)\n")
    parts.append("This file is generated by `python scripts/generate_results_md.py`.\n")

    if cross_path.exists():
        cross = pd.read_csv(cross_path)
        # In-city baselines (train == test)
        in_city = cross[cross["train"] == cross["test"]].copy()
        # Prefer xgboost rows if present
        in_city = in_city.sort_values(["model", "test"], ascending=[True, True])
        parts.append("## Cross-city evaluation (in-city baselines)\n")
        cols = ["train", "test", "model", "log_target", "R2", "MAE", "RMSE", "Spearman"]
        # tolerate case mismatches
        ren = {c: c for c in in_city.columns}
        for want in ["R2","MAE","RMSE","Spearman"]:
            if want not in in_city.columns:
                # common lowercase
                low = want.lower()
                if low in in_city.columns: ren[low] = want
        in_city = in_city.rename(columns={k:v for k,v in ren.items() if k!=v})
        keep = [c for c in cols if c in in_city.columns]
        headers = ["Train","Test","Model","log_target","R²","MAE","RMSE","Spearman"]
        headers = headers[:len(keep)]
        parts.append(md_table(in_city[keep].head(12), keep, headers))
        parts.append("")

    if abl_path.exists():
        abl = pd.read_csv(abl_path)
        parts.append("## NYC ablation\n")
        # sort best first
        if "r2" in abl.columns:
            abl2 = abl.sort_values(["r2","spearman"], ascending=[False, False]).copy()
        else:
            abl2 = abl.copy()

        cols = ["feature_set","model","log_target","n_features","r2","mae","rmse","spearman"]
        cols = [c for c in cols if c in abl2.columns]
        headers = ["Feature set","Model","log_target","#feat","R²","MAE","RMSE","Spearman"]
        headers = headers[:len(cols)]
        parts.append(md_table(abl2[cols].head(10), cols, headers))
        parts.append("")

        if "r2" in abl2.columns:
            best = abl2.iloc[0].to_dict()
            best_line = (
                f"**Best NYC config:** `{best.get('feature_set')}` + `{best.get('model')}` "
                f"(log_target={bool(best.get('log_target'))}) → "
                f"R²={float(best.get('r2')):.3f}, MAE={fmt_money(float(best.get('mae')))}, "
                f"Spearman={float(best.get('spearman')):.3f} (n_features={int(best.get('n_features'))})."
            )
            parts.append(best_line)
            parts.append("")

    out_md = OUT_DIR / "RESULTS.md"
    out_md.write_text("\n".join(parts).strip() + "\n", encoding="utf-8")
    print(f"✅ Wrote: {out_md}")
    return 0

if __name__ == "__main__":
    raise SystemExit(main())
